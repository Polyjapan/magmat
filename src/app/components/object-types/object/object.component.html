<mat-spinner *ngIf="!object"></mat-spinner>

<div *ngIf="object" fxLayout="row" fxLayout.lt-md="column" fxLayoutGap="20px">

  <div>
    <mat-card>
      <mat-card-title>Détails de l'objet :: {{object.objectType.name}} {{object.object.suffix}}</mat-card-title>

      <ul>
        <li *ngIf="object.object.assetTag"><b>Asset Tag</b> : <code>{{object.object.assetTag}}</code></li>
        <li><b>Description
          :</b> {{object.object.description ? object.object.description : object.objectType.description }} <i
          *ngIf="!object.object.description">(hérité)</i></li>
        <li><b>Stockage hors convention :</b> {{storageLocationToString(object.storageLocationObject, 'N/A')}} <i
          *ngIf="!object.object.storageLocation">(hérité)</i></li>
        <li><b>Stockage en convention :</b> {{storageLocationToString(object.inconvStorageLocationObject, 'N/A')}} <i
          *ngIf="!object.object.inconvStorageLocation">(hérité)</i></li>
        <li><b>Prêt parent :</b> {{externalLoanToString(object.partOfLoanObject, 'N/A')}} <i
          *ngIf="!object.object.partOfLoan">(hérité)</i></li>
        <li><b>Etat acutel :</b> {{statusToString(object.object.status)}}</li>
      </ul>
    </mat-card>
  </div>

  <div fxFlex="60%" fxFlex.lt-md="100%" fxLayout="column" fxLayoutGap="20px">

    <mat-card>
      <mat-card-title>Changement d'état</mat-card-title>

      <ng-container [ngSwitch]="object.object.status">
        <p *ngSwitchCase="ObjectStatus.IN_STOCK">
          Indiquez un utilisateur pour ouvrir un prêt.
        </p>
        <p *ngSwitchCase="ObjectStatus.LOST">
          Indiquez l'utilisateur ayant ramené l'objet pour clore la perte.
        </p>
        <p *ngSwitchCase="ObjectStatus.OUT">
          Indiquez l'utilisateur pour clore le prêt, déclarer une perte, ou indiquer un dépot d'objet.
        </p>
        <p *ngSwitchCase="ObjectStatus.RESTING">
          Indiquez l'utilisateur pour clore le prêt ou déclarer la récupération d'un objet déposé.
        </p>
      </ng-container>

      <form>
        <app-select-user (selectedUser)="lendTo = $event"></app-select-user>

        <ng-container [ngSwitch]="object.object.status">
          <ng-container *ngSwitchCase="ObjectStatus.IN_STOCK">
            <button [disabled]="sending" *ngIf="lendTo" type="submit" (click)="declareLoaned()" mat-stroked-button
                    color="accent" style="width: 100%;">Ouvrir un prêt
            </button>
          </ng-container>
          <ng-container *ngSwitchCase="ObjectStatus.LOST">
            <button [disabled]="sending" *ngIf="lendTo" type="submit" (click)="declareLoaned()" mat-stroked-button
                    color="accent" style="width: 50%;">Déclarer retrouvé et prêter
            </button>
            <button [disabled]="sending" *ngIf="lendTo" type="submit" (click)="declareInStock()" mat-stroked-button
                    style="width: 50%;">Déclarer retrouvé et stocker
            </button>
          </ng-container>
          <ng-container *ngSwitchCase="ObjectStatus.OUT">
            <button [disabled]="sending" *ngIf="lendTo" type="submit" (click)="declareInStock()" mat-stroked-button
                    color="accent" style="width: 33%;">Fermer le prêt
            </button>
            <button [disabled]="sending" *ngIf="lendTo" type="submit" (click)="declareResting()" mat-stroked-button
                    style="width: 34%;">Déposer quelque part
            </button>
            <button [disabled]="sending" *ngIf="lendTo" type="submit" (click)="declareLost()" mat-stroked-button
                    color="warn" style="width: 33%;">Déclarer perdu
            </button>
          </ng-container>
          <ng-container *ngSwitchCase="ObjectStatus.RESTING">
            <button [disabled]="sending" *ngIf="lendTo" type="submit" (click)="declareInStock()" mat-stroked-button
                    color="accent" style="width: 50%;">Fermer le prêt
            </button>
            <button [disabled]="sending" *ngIf="lendTo" type="submit" (click)="declareLoaned()" mat-stroked-button
                    style="width: 50%;">Récupérer
            </button>
          </ng-container>
        </ng-container>
      </form>
    </mat-card>

    <mat-card>
      <mat-card-title>Historique de l'objet</mat-card-title>


      <table mat-table [dataSource]="logs" class="mat-elevation-z4" style="width: 100%;">
        <ng-container matColumnDef="timestamp">
          <th mat-header-cell *matHeaderCellDef> Heure</th>
          <td mat-cell *matCellDef="let elem"> {{dateFormat(elem)}} </td>
        </ng-container>

        <ng-container matColumnDef="source">
          <th mat-header-cell *matHeaderCellDef> Ancien état</th>
          <td mat-cell *matCellDef="let elem"> {{statusToString(elem.objectLog.sourceState)}} </td>
        </ng-container>

        <ng-container matColumnDef="target">
          <th mat-header-cell *matHeaderCellDef> Nouvel état</th>
          <td mat-cell *matCellDef="let elem"> {{statusToString(elem.objectLog.targetState)}} </td>
        </ng-container>

        <ng-container matColumnDef="user">
          <th mat-header-cell *matHeaderCellDef> Utilisateur</th>
          <td mat-cell *matCellDef="let elem"><b>{{elem.user.details.firstName}} {{elem.user.details.lastName}}</b>
            ({{elem.user.details.phoneNumber}})
          </td>
        </ng-container>

        <ng-container matColumnDef="admin">
          <th mat-header-cell *matHeaderCellDef> Administrateur</th>
          <td mat-cell
              *matCellDef="let elem">{{elem.changedBy.details.firstName}} {{elem.changedBy.details.lastName}}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['timestamp', 'source', 'target', 'user', 'admin']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['timestamp', 'source', 'target', 'user', 'admin'];"></tr>
      </table>
    </mat-card>
  </div>


</div>


